<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Circle Bubble Shooter</title>
<style>
  body { margin: 0; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; }
  canvas { background: #222; border: 2px solid #fff; border-radius: 8px; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="480" height="640"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const RADIUS = 18;
const CENTER_X = canvas.width / 2;
const CENTER_Y = canvas.height / 2 + 50;
const COLORS = ["red", "yellow", "green", "blue", "purple", "orange"];

const ITEM_TYPES = {
  NORMAL: "normal",
  COLOR_CHANGE: "colorChange",
  BOMB: "bomb",
  DUAL: "dual"
};

let circleBalls = [];
let currentBall = null;

// 초기 원판 구슬
function initCircle() {
  const count = 20; 
  for (let i = 0; i < count; i++) {
    let type = ITEM_TYPES.NORMAL;
    const rand = Math.random();
    if (rand < 0.05) type = ITEM_TYPES.COLOR_CHANGE;
    else if (rand < 0.1) type = ITEM_TYPES.BOMB;
    else if (rand < 0.15) type = ITEM_TYPES.DUAL;

    circleBalls.push({
      angle: (i / count) * Math.PI * 2,
      distance: 100,
      color: COLORS[Math.floor(Math.random() * COLORS.length)],
      type
    });
  }
}

// 발사 구슬
function newCurrentBall() {
  let type = ITEM_TYPES.NORMAL;
  const rand = Math.random();
  if (rand < 0.05) type = ITEM_TYPES.COLOR_CHANGE;
  else if (rand < 0.1) type = ITEM_TYPES.BOMB;
  else if (rand < 0.15) type = ITEM_TYPES.DUAL;

  currentBall = {
    x: canvas.width / 2,
    y: RADIUS + 10,
    dx: 0,
    dy: 0,
    color: COLORS[Math.floor(Math.random() * COLORS.length)],
    type
  };
}

// 구슬 그리기
function drawBall(x, y, ball) {
  ctx.beginPath();
  ctx.arc(x, y, RADIUS, 0, Math.PI * 2);
  ctx.fillStyle = ball.color;
  ctx.fill();
  ctx.strokeStyle = "#000";
  ctx.stroke();

  ctx.fillStyle = "#fff";
  ctx.font = "12px Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  if (ball.type === ITEM_TYPES.COLOR_CHANGE) ctx.fillText("C", x, y);
  if (ball.type === ITEM_TYPES.BOMB) ctx.fillText("B", x, y);
  if (ball.type === ITEM_TYPES.DUAL) ctx.fillText("D", x, y);
}

// 중앙 원판 그리기
function drawCircle() {
  for (let ball of circleBalls) {
    const x = CENTER_X + Math.cos(ball.angle) * ball.distance;
    const y = CENTER_Y + Math.sin(ball.angle) * ball.distance;
    drawBall(x, y, ball);
  }
}

// 충돌 체크
function checkCollision() {
  for (let ball of circleBalls) {
    const x = CENTER_X + Math.cos(ball.angle) * ball.distance;
    const y = CENTER_Y + Math.sin(ball.angle) * ball.distance;
    const dx = x - currentBall.x;
    const dy = y - currentBall.y;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist < RADIUS * 2) {
      // 아이템 효과
      if (ball.type === ITEM_TYPES.COLOR_CHANGE) {
        ball.color = COLORS[Math.floor(Math.random() * COLORS.length)];
      } else if (ball.type === ITEM_TYPES.BOMB) {
        const index = circleBalls.indexOf(ball);
        for (let i = -3; i <= 3; i++) {
          const idx = (index + i + circleBalls.length) % circleBalls.length;
          circleBalls[idx] = null;
        }
        circleBalls = circleBalls.filter(b => b);
      } else if (ball.type === ITEM_TYPES.DUAL) {
        const index = circleBalls.indexOf(ball);
        const left = circleBalls[(index - 1 + circleBalls.length) % circleBalls.length];
        const right = circleBalls[(index + 1) % circleBalls.length];
        if (left && right && (left.color === right.color)) {
          circleBalls[index] = null;
          circleBalls = circleBalls.filter(b => b);
        }
      }

      // 새 구슬 붙이기
      const angle = Math.atan2(y - CENTER_Y, x - CENTER_X);
      circleBalls.push({
        angle,
        distance: 100,
        color: currentBall.color,
        type: currentBall.type
      });

      newCurrentBall();
      break;
    }
  }
}

// 게임 루프
function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawCircle();

  if (currentBall) {
    drawBall(currentBall.x, currentBall.y, currentBall);
    currentBall.x += currentBall.dx;
    currentBall.y += currentBall.dy;

    // 좌/우 벽 반사
    if (currentBall.x - RADIUS < 0) {
      currentBall.x = RADIUS;
      currentBall.dx *= -1;
    }
    if (currentBall.x + RADIUS > canvas.width) {
      currentBall.x = canvas.width - RADIUS;
      currentBall.dx *= -1;
    }

    // 하단 벽 반사
    if (currentBall.y + RADIUS > canvas.height) {
      currentBall.y = canvas.height - RADIUS;
      currentBall.dy *= -1;
    }

    checkCollision();
  }

  requestAnimationFrame(gameLoop);
}

// 마우스 클릭 발사
canvas.addEventListener("click", (e) => {
  if (!currentBall) return;
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const angle = Math.atan2(my - currentBall.y, mx - currentBall.x);

  currentBall.dx = Math.cos(angle) * 5;
  currentBall.dy = Math.sin(angle) * 5;
});

// 시작
initCircle();
newCurrentBall();
gameLoop();
</script>
</body>
</html>
